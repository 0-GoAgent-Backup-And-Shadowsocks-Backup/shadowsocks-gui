// Generated by CoffeeScript 1.6.2
(function() {
  var gui, load, local, restartServer, saveChanges, util;

  gui = require('nw.gui');

  util = require('util');

  util.log = function(s) {
    console.log(new Date().toLocaleString() + (" - " + s));
    $('#divWarning').show();
    return $('#divWarning').text(s);
  };

  local = require('./shadowsocks-nodejs/local');

  saveChanges = function() {
    var config;

    config = {};
    $('input,select').each(function() {
      var key, val;

      key = $(this).attr('data-key');
      val = $(this).val();
      config[key] = val;
      return window.localStorage.setItem(key, val);
    });
    util.log('config saved');
    restartServer(config);
    return false;
  };

  load = function() {
    var config;

    config = {};
    $('input,select').each(function() {
      var key, val;

      key = $(this).attr('data-key');
      val = window.localStorage.getItem(key) || '';
      if (val) {
        $(this).val(val);
      }
      return config[key] = this.value;
    });
    return restartServer(config);
  };

  restartServer = function(config) {
    var e, start;

    if (config.server && +config.server_port && config.password && +config.local_port && config.method && +config.timeout) {
      start = function() {
        var e;

        if (window.local == null) {
          try {
            window.local = local.createServer(config.server, config.server_port, config.local_port, config.password, config.method, 1000 * (config.timeout || 600));
          } catch (_error) {
            e = _error;
            alert(e);
          }
        }
        return $('#divError').fadeOut();
      };
      if (window.local != null) {
        try {
          return window.local.close(function() {
            window.local = null;
            return start();
          });
        } catch (_error) {
          e = _error;
          util.log(e);
          window.local = null;
          return start();
        }
      } else {
        return start();
      }
    } else {
      return $('#divError').fadeIn();
    }
  };

  $('#buttonSave').on('click', saveChanges);

  $('#buttonConsole').on('click', function() {
    return gui.Window.get().showDevTools();
  });

  load();

}).call(this);
